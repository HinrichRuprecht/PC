<!DOCTYPE HTML PUBLIC "-//W3C//Dtd HTML 4.0 Transitional//EN">
<HEAD>
        <META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8"/>
        <TITLE>Playing Cards</TITLE>
        <META name="AUTHOR" CONTENT="Hinrich Ruprecht"/>
        <link href="../PC/img/L-KrPiHeKa.ico" rel="Shortcut Icon" />
        <meta name="copyright" content="H. Ruprecht 2020-2021" />
        <meta name="license" content="GNU General Public License v2 or later"/>
</HEAD>
<!--
Client part for PC.pl (playing cards).
Requires port 80 opened on the apache server (ufw enable; ufw allow 80/tcp),
and in the router forwarding of port 80 to the apache server.
-->
<body>
<html>
<style>
body { font-family: Dejavu Sans; }

.spades { color: black; font-size: 400%; }
.hearts { color: red; font-size: 400%; }
.diamonds { color: orange; font-size: 400%; }
.clubs { color: darkgreen; font-size: 400%; }
.main { color: blue; font-size: 400%; }
.mate { color: orange; font-size: 400%; }
.win { color: yellow; }
.grey { color: grey; }
.trick { font-size: 200%; }
.owncards { font-size: 350%; }
.announces { font-size: 200%; }
.small { font-size: 200%; }
.logo { max-width: 7%; height: auto; font-size: 200%; }
.special { font-size: 200%; }
.summ { font-size: 200%; }
.text { background-color: white; }

div.logo { position: absolute; left: 0%; top: 0%; z-index: 0; }
div.partner { display: inline; position: absolute; left: 10%; top: 0%; 
	    max-width: 40%;}
div.summary { position: absolute; right: 0%; top: 0%; max-width: 40%; 
	overflow-x: auto; overflow-y: auto;}
div.special { position: absolute; right: 40%; top: 0%; }
div.msg { position: absolute; right: 0%; bottom: 40%; 
    max-width: 35%; max-height: 30%; overflow-x: auto; overflow-y: auto;}
div.hint { position: absolute; right: 28%; bottom: 30%; width: 25%; }
div.announce { position: absolute; right: 8%; bottom: 0%;
    max-width: 20%; max-height: 30%; overflow-x: auto; overflow-y: auto;}
div.trick { position: absolute; left: 30%; top: 30%; }
div.own { position: absolute; left: 0%; bottom: 0%; max-width: 72%; }

div.j-logo { position: absolute; left: 0%; top: 0%; z-index: 0; }
div.j-partner { position: absolute; left: 10%; top: 0%; max-width: 40%; 
	z-index: 0; }
div.j-summary { position: absolute; right: 0%; top: 0%; max-width: 40%; 
	overflow-x: auto; overflow-y: auto;}
div.j-special { position: absolute; right: 40%; top: 0%; }
div.j-msg { position: absolute; right: 15%; bottom: 20%; 
    max-width: 35%; overflow-x: auto; max-height: 30%; overflow-y: auto;}
div.j-hint { position: absolute; right: 10%; bottom: 15%; }
div.j-announce { position: absolute; right: 8%; bottom: 0%; 
    max-width: 20%; overflow-x: auto; max-height: 15%; overflow-y: auto;}
div.j-trick { position: absolute; right: 0%; top: 40%; }
div.j-own { position: absolute; left: 0%; bottom: 0%; max-width: 72%; }
/*      max-height: 20%; overflow-y: auto;} */

div.info { position: absolute; right: 0%; bottom: 0%; }
div.j-info { position: absolute; right: 0%; bottom: 0%; }
</style>
<body lang="de-DE" dir="Ltr">
<div id="JitsiFrame"></div>
<div id="LOGO" class="logo">
    <span id="game">
	<img width=60 src="../PC/img/L-KrPiHeKa.png" title="Card Games">
	</span>
    <br>
    <span id="uu" onClick="setImgMode();" 
	title="Klick for next utf/image card presentation">
	</span>
<!--    <img id="uu" width=60 src="../PC/img/L-BlattUmsch.png"
	onClick="setImgMode();" title="Klicken fÃ¼r UTF/Blatt-Umschaltung">
-->
    <br>
    <a id="jitsiLink" href="" target='jitsi' 
	    onClick="return setJitsi();">
	<IMG id="ji" width="60" 
	    title="Klick to switch jitsi handling"
	    src="../PC/img/Logo_Jitsi.svg.png" >
    </a><br>
    <span id="ownNum" title="player number" class="text"></span>
</div>
<div id="PARTNER"></div>
<div id="SUMMARY"></div>
<div id="SPECIAL"></div>
<div id="MSG"></div>
<div id="OWN"></div>
<div id="TRICK"></div>
<div id="HINT"></div>
<div id="ANNOUNCE"></div>
<div id="INFO"></div>

<!--
<iframe name="jitsi" title="jitsi" id="jitsi"
	    allowtransparency="true" xframeborder="1" scrolling="no" 
	    src=""
	    style="height:80%; background: none; border: 2px; bottom: 10%; 
	    float: none; left: 0px; margin: 0px; padding: 0px; 
	    position: absolute; right: 0px; width:80%;">
	    </iframe>
-->
<script src='https://meet.jit.si/external_api.js'></script>
<script language="JavaScript">
"use strict";
var language=
    (navigator["language"])?navigator["language"]:navigator["userLanguage"];
var g_language="en";
language=(language)? language.substr(0,2).toLowerCase() : g_language;

var alrtArr=new Array();
var bgPosition0='#ff00ff'; // background color (magenta)
var bgCP='lightgreen'; var bgSel='lightgreen';
var divStyle=new Array();
//divStyle['LOGO']='small';
divStyle['PARTNER']='small';
divStyle['SUMMARY']='small';
divStyle['SPECIAL']='special';
divStyle['MSG']='small';
divStyle['OWN']='owncards';
divStyle['HINT']='small';
divStyle['TRICK']='owncards';
divStyle['ANNOUNCE']='announces';
divStyle['INFO']='small';
divStyle['LOGO']='announces';
var imgSize=new Array();
imgSize['small']=36;
imgSize['owncards']=50;
imgSize['announces']=50;
imgSize['own']=30;
imgSize['trick']=70;
imgSize['summ']=20;
imgSize['logo']=60;
imgSize['special']=50;
var sorted=new Array(); var sortId='';

// split html url:  IPADDR/subdir/prog.html to build perl url:
var hrefParts=splitURL(document.location.href);
// If program ends on a number (test version), use that in subdir, thus
// XXX/PC1.html uses XXX1/PC.pl 
var prot=hrefParts[0];
var fileParts=/^(.+\D)(\d+)$/.exec(hrefParts[3]);
if (fileParts!=null)
    { hrefParts[2]+=fileParts[2]; hrefParts[3]=fileParts[1]; }
var PCserver=prot+"//"+hrefParts[1]+"/cgi-bin/"+hrefParts[2]
	+"/"+hrefParts[3]+".pl";

var params=readParams(); var sep='\n';
var usePrompt=params['prompt']; var reqCnt=0; var stepBack=0; var sortSelected="";
var cancelTimeout=0;
var test=params['test'] || 0;
if (params['l']) language=params['l'].substr(0,2).toLowerCase();
if (test) alert("PCserver="+PCserver);

if (usePrompt>0) sep='|';
var http = createRequestObject();

var action="", cnt=0, np=3, tmp; var minWait=1000;
var name2p=new Array();
var playerId=params['P'];
tmp="Bitte Spieltisch-Spieler eingeben (z.B. OhLR-Jo) ! ";
if (playerId==undefined) {
    playerId=getCookie("PC-P");
    if (playerId.charAt(0) == '"')
	playerId = playerId.substring(1,playerId.length-2);
    if (test && playerId!="") alert("P="+playerId);
    playerId=prompt(tmp,playerId);
    if (!playerId) throw new Error(tmp);
    }
//if (playerId=="") {
//    }
var ckie='PC-P='+encodeURI(playerId)+';SameSite=strict'; 
    // avoid character set problems, and restrict read
document.cookie=ckie;

var table=playerId.split("-")[0];
var player=playerId.split("-")[1];

var allowSettings=params['set'] || 0;
var useJitsi=params['J']; if (useJitsi==null) useJitsi=1;
var utfImg=params['img'] || 1;
var learner=params['L'] || 0; 
var clientMode=params['mode'] || "C";
var jWidth=params['W'] || '50%';
var jHeight=params['H'] || '80%';

var jitsiStatus=0, jitsiSrc="https://meet.jit.si/"+table+"-numr", 
    jitsiLogo="../PC/img/Logo_Jitsi.svg.png", jitsiWindow, jitsiApi;
var helpWindow;

var colorNames // 0        1        2         3       4      5      6      7
    =new Array("spades","hearts","diamonds","clubs","main","mate","win","grey");
var help=new Array(), cardUTF=new Array(), cardColor=new Array();
var Msg=new Array(); var category=new Array();
var positions=new Array(); var ownTrumps=""; var setTrick_=0;
var changeCards="";
var cardStat='';
var colorsEn=new Array("spade","heart","diamond","club"); var tmp;
var cardsUtfEn=new Array(); // used for image names
    cardsUtfEn['1']='ace'; cardsUtfEn['B']='jack';
    cardsUtfEn['D']='queen'; cardsUtfEn['E']='king'; cardsUtfEn['A']='10';

var allCards="";
var ownHand=""; var ownNum=-1, ownPos=-1, CPP=0, T=-1, PC=0, POS="";
var info=new Array(); var config=new Array();
var miscButtons=''; // ??reload,reservation,  ,wc=wait(internally)
//if (allowSettings) miscButtons+=',ss';
if (learner) miscButtons+=',hl';
if (params['b']!=null) miscButtons+=','+params['b'];
var ownButtons=''; // set in checkCards: marriage,poverty,5 nines 
var lastAct="";

// ALL status/info variables which are used in .html must be preset here
// or by sending as %CONFIG from server
info[':ID']=playerId; info['myP']=''; info['FS']=0;
info['AUTO']="";
info['maxImg']=2; // card images from directories img1 ... img<maxImg>

document.title=table+"/"+player;

stdConfig();
joinTable(); // table,player
//document.getElementById("MSG").innerHTML="<b>warte auf Spielkonfiguration</b>";
setPC("MSG","wc");
if (test>0) minWait=5000;

//setPC("LOGO","lu/ji");
setDivStyle("");
setTimeout('act("S","rl")',minWait);

function stdConfig() { //  used until more comes from server
setConfig('%Local_uu=L-BlattUmsch.png;card presentation'); 
setConfig('%Local_ji=Logo_Jitsi.svg.png;jitsi ahndling');
setConfig('%Symbol_xx=1F0B0;place-holder (soemthing missing));1'); 
setConfig('%Server_rl=27F3;reload'); // open circle (reload)
setConfig('%Symbol_gm=L-KrPiHeKa.png;card games');
setConfig('%Symbol_wc=231B;hourglass/wait'); //alt: 23F3
    } // stdConfig

function initTable() {
  var n=0;
  var game=info['GAME'] || info['game'];
  if (game==null) { alert("no game"); return; }
  if (test) alrt("initTable:"+game);
    //{ cancelTimeout=setTimeout('initTable()',1000); if (!test) return; }
  if (test==999) {
    test=-1; allCards="";
    for (let card in cardUTF) { allCards+=card; n++; }
    alert("allCards="+allCards);
    if (n>1) test--;
    }
  if (test==99) {
    tmp="+ cc UTF col img\n";
    for (var k in cardUTF) {
	tmp+="* "+k+"= 0x"+cardUTF[k]+" "+colorNames[cardColor[k]]
	    +" I"+cardUTF[k]+"-"+cardColor[k]+".png\n"; }
    tmp+="+ config\n"; n=0;
    for (var k in config) { tmp+="% "+k+"="+config[k]+"\n"; n++; }
    alert(tmp);
    if (n>1) test--;
    }
  if (jitsiStatus>0) setDivStyle("j-"); else setDivStyle("");

  allCards=info['cardDeck'];
  //if (test>3) alert("allCards="+allCards);
  //document.getElementById("uu").innerHTML=
  //	formatCards("uu","logo","U_",utfImg+1);
  //setJitsi(useJitsi);
  setImgMode(utfImg);

//  if (document.getElementById("game")!=null) {
//	document.getElementById("game").src="../PC/img/"+game+".png";
//	document.getElementById("game").title=game;
//	}
  } // initTable

function setImgMode(imgMode) {
    if (imgMode==null) utfImg=(+utfImg+1)%info['maxImg'];
    else utfImg=imgMode;
    var utfImg_=(utfImg<info['maxImg']-1 ? +utfImg+1 : 1);
    var tmp=getUTFimg("uu",null,utfImg_);
	    //if (test>3) alrt("Image src for UTF-Umsch.="+tmp);
	    //if (utfImg>0) 
//    if (document.getElementById("uu")!=null)
//	document.getElementById("uu").src=tmp;
    //if (test>3)
	//alert("utf: i="+imgMode+" u="+utfImg+" u_="+utfImg_+" src="+tmp);
    
    // if (info['R']>0 && test!=-1) allCards="";
    var rules=info['rules'] || "";
    if (rules) rules="/"+rules;
    if (PC==0) setPC("PARTNER",allCards+rules);
    setPC("INFO","rl/ls/li/lc"); // info symbol, keyboard (chat), stop
    setHTML("game",formatCards("gm","logo")); //,"",utfImg_,1));
    setHTML("uu",formatCards("uu","logo","",utfImg_,1));

    if (imgMode==null) act("S","rl"); // reload
    //var tmp=formatCards("uu","logo","",utfImg_,1);
    //document.getElementById("uu").innerHTML=tmp;
   } // setImgMode

function setDivStyle(prefix) {
    var d;
    for (let divName in divStyle) {
	d=document.getElementById(divName);
	if (d!=null) d.className=prefix+divName.toLowerCase();
	//if (test) setPC(divName,"["+divName+"]");
	}
    }

function setLogos() {
    var logos=new Array("uu","ji","game","ownNum");
    for (let i in logos) {
	var logo=logos[i];
	var d=document.getElementById(logo); // +"Logo"
	if (d!=null && Msg[logo]!=null) d.title=Msg[logo];
	else alrt("*no SetLogo "+logo);
	}
    }

function setJitsi(newState) {
    if (newState!=null) jitsiStatus=newState;
    else jitsiStatus=(jitsiStatus+1)%3;
    
    var w = window.innerWidth;
    var h = window.innerHeight;

    if (jitsiStatus>0) setDivStyle("j-"); else setDivStyle("");
    if (useJitsi==0) {
	document.getElementById("JitsiFrame").innerHTML=
	    '<iframe width="'+jWidth+'" height="'+jHeight+'" '
		+'style="border:1px solid black; background-color: grey;">'
	    +'</iframe>';
	return false;
	}

    const jitsiURL='meet.jit.si'; // prot+'//'+
    var pName=player;
    if (ownNum!=null && info['N'+ownNum]!=null) pName=info['N'+ownNum];
    var par=info['JitsiRoom']+'#userInfo.displayName="'+pName+'"';
    var url=jitsiURL+'/'+par;
    setHTML("ANNOUNCE","<a href='"+'https://'+url+"' target='_blank'>"
		+"Jitsi-Link</a>");
    document.getElementById("jitsiLink").href='https://'+url;
    
    if (jitsiStatus==1) {
	var tmp=document.getElementById("jiannouncements");
	if (tmp) tmp.title=url;
	//document.getElementById("jiannouncements").src=jitsiSrc; //"./Bildschirmfoto.png";
		//jitsiannouncements;	// jitsiSrc;
	const domain = jitsiURL;
	const options = {
	    roomName: info['JitsiRoom'],
	    width: jWidth,
	    height: jHeight,
	    //noSSL: false,
	    userInfo: {
		displayName: pName,
		}
	    //parentNode: document.querySelector('#jitsi')
	    };
	//disabled: ?
	//setDivStyle("j-");
	if (test>0) alert("Jitsi-URL: "+url+" prot="+prot);
	else if (prot=="https:") { // useJitsi==2 && 
	    if (jitsiApi==null) {
		if (confirm(_("&jitsi1()")))
		    jitsiApi = new JitsiMeetExternalAPI(domain, options);
		}
	    }
	else if (jitsiWindow==null || jitsiWindow.closed) {
	    setHTML("ANNOUNCE","<a href='"+'https://'+url+"'>Jitsi-Link</a>");
	    if (!confirm(_("&jitsi2()"))) { } // return false;
	    jitsiWindow=open('https://'+jitsiURL+'/'+par, 'popup-jitsi', 
		'height=600, width=800, toolbar=no, status=no, menubar=no,'
		+'scrollbars=no, location=no, top=0, left=0, resizable=yes');
	    return false; // true; 
	    }
	else jitsiWindow.focus();
	}
    else if (jitsiStatus==2) { // Jitsi-Layout w/o focus
	if (jitsiApi!=null) {
		if (confirm(_("&jitsi3()"))) {
		    jitsiApi.dispose();
		    jitsiApi=null;
		    }
		else { jitsiStatus-=1; return false; }
		}
	jitsiStatus=0;
	setDivStyle("");
	}
   return false; // avoids opening of another window
   }

function setHelpUTF(cardId,utf,helpText,color) {
    cardUTF[cardId]=utf;
    helpText=helpText.replace(/\\n/g,"\n");
    help[cardId]=helpText;
    if (color!=undefined) cardColor[cardId]=color;
    }

function _(str) { // replace &NAME(PARAM,...) by text from Msg hash
    if (str==null) return null;
    while (1) {
	var parts=/^(.*)\&([\w\d]+)\(([^\)]*)\)(.*)$/.exec(str);
	if (parts==null) break;
	var name=parts[2];
	var repl=Msg[name];
	if (repl==null) {
	    repl=name;
	    repl=repl.replace(/(\d+)/,' $1');
	    while (1) {
		var nParts=/^(.*[^A_Z\s])([A-Z])(.*)$/.exec(repl);
		if (nParts==null) break;
		repl=nParts[1]+" "+nParts[2].toLowerCase()+nParts[3];
		alrt("repl="+repl);
		}
	    }
	else {
	    var par=parts[3].split(",");
	    for (var i=1; i<=par.length; i++) {
		while (1) {
		    var pos=repl.indexOf("$"+i);
		    if (pos<0) break;
		    repl=repl.substr(0,pos)+par[i-1]+repl.substr(pos+2);
		    }
		}
	    }
	str=parts[1]+repl+parts[4];
	}
    return str;
    } // _

function setPC(divName,str) {
    var P, P_, l, res="", tmp, divName_=divName, pos=info['POS'];
    if (str==null) str=info[divName];
    else info[divName]=str;
    if (divStyle[divName]==undefined) {
	if (test>3) alrt("unkown div: setPC("+divName+","+str+")");
	return 0;
	}
    //if (test>2 || divName=="T0") alrt("setPC:("+divName+","+str+")");
    str=_(str);
    if (test) alrt("setPC("+divName+","+str+")");
    switch (divName) {
	case "OWN":  // special formating !!
	    str=miscButtons;
	    res=formatCards(str,"own","Ao")+res;
	    if (test>3) alrt("buttons: "+res);
	    var res2="";
	    if (T==0) {
		res2+=cardStat;
		}
	    else { 
		tmp=cardStat.indexOf("["); 
		if (tmp>0) res2+=cardStat.substr(0,tmp); // only card symbols
		}
	    res2+=formatCards(ownHand,"owncards","O_");
	    if (ownNum>=0) {
		ownButtons=info["B."+ownNum] || "";
		if (ownButtons!="")
		    res2+=formatCards("/"+ownButtons,"announces","Ab");
		}
	    res+="<br>"+res2;
	    break;
	case "PARTNER":
	    res=formatCards(str,divStyle[divName],"P_");
	    break;
	case "ANNOUNCE": case "LOGO":
	    res=formatCards(str,divStyle[divName],divName.substr(0,2));
	    break;
	case "INFO": res=formatCards(str,divStyle[divName],"Ai"); 
	    tmp=document.getElementById("CC");
	    res+='<br><span id="CC">'+(tmp ? tmp.innerHTML : "")+'</span>';
	    break;

	default:
	    res=formatCards(str,divStyle[divName]);
	}
    if (!document.getElementById(divName)) 
	{ if (test) alrt("no-existing: "+divName+"/"+divName_+"="+res); }
    else setHTML(divName,res);
    return 1;
    } // setPC

function formatTrick(cards) { // not used !!!
    var cards_=cards.split(",");
    var str="v"+cards_[0]+"^"+cards_[1]+"v"+cards_[2]+"/    v"+cards_[3];
    return str;
    } // formatTrick

function formatCards(cardIds,sizeClass,setClick,utfImg_,noTitle) { 
    // returns html code to show card for cardIds
    // cardIds : string of card ids, 2 characters each
    //	1st: 0=spades, 1=hearts, 2=diamonds, 3=clubs
    //	2nd: A=Ace, 2-9=2-9, J=Jack, Q=Queen, K=King, 1=10
    //  "00" = back of card (black), 
    //  "1*" = red joker, "2*" = black joker, ":0" = white joker
    // separators: " "->html space, /->html newline, "," ignored
    // formatting: v:<sub>, ^:<sup>, <:<small>
    //     [pure text] : inserted as is
   // U+1F0A0 = back, A1=Spades/Pik Ace, AB=Jack, AC=Knight, AD=Queen. AE=King
   //		      B1=Hearts, C1=Diamonds/Karo, D1=Clubs/Kreuz
   // also see specials
  if (cardIds==null || cardIds.indexOf("undefined")>=0) {
    if (test)
	alrt("formatCards("+cardIds+";"+sizeClass+";"+setClick+") ignored");
    return "";
    }
  if (setClick==null) setClick="";
  if (cardIds==null) cardIds="";
  if (utfImg_==null) utfImg_=utfImg;
  else if (utfImg_>=+info['maxImg']) utfImg_=1; // 0=utf characters
  //if (test>0) alrt("show:"+cardIds+"|"+sizeClass+"|"+divId+"|"+setClick);
  var color, utf, pos, cardId, tmp;
  var res=''; var nCards=0; var prevCard='';
  var len=cardIds.length;
  var form0='', form1='', noUTF='';
  var idNum=0;
  for (pos=0; pos<len; pos+=2) {
    var uImg=utfImg_;
    cardId=cardIds.substr(pos,2);
    color=cardId.substr(0,1); 
    if (color=="[") { // start of pure text
	tmp=cardIds.indexOf("]",pos+1);
	if (tmp<0) tmp=len;
	res+=cardIds.substr(pos+1,tmp-(pos+1));
	pos=tmp-1;
	continue; 
	}
    switch (color) {
	case ",": 
	case ";": 
	    pos--; continue; // ignore
	case " ": res+="&nbsp;"; pos--; continue; // &nbsp; backside of card
		    // utf='A0'; ?
	case "/": res+='<br>'; pos--; continue;
	case "v": form0+='<sub>'; form1='</sub>'+form1; pos--; continue;
	case "^": form0+='<sup>'; form1='</sup>'+form1; pos--; continue;
	case "<": form0+='<small>'; form1='</small>'+form1; pos--; continue;
	
	default: 
	}
    color=cardColor[cardId]; if (color==undefined) color=0; // black
    var cardId_=cardId;
    if (cardUTF[cardId]==null) 
	{ if (test) alrt("formatCards: "+cardId+":cUTF=null"); }
    else if (cardUTF[cardId].substr(0,1)=='&') 
	cardId_=cardUTF[cardId].substr(1); // &<cardId>

    utf=getUTFimg(cardId_,color,uImg);
    if (utf==undefined || utf=="") { 
	noUTF+=cardId; 
	utf="_"+cardId+"_";
	uImg=0;
	}
    else if (/\.png/.exec(utf)) uImg=1;
    if (uImg>0) {
	nCards++;
	res+='<img src="'+utf+'"'; 
	if (uImg>=2 && /[0123][\dJQKA]$/.exec(cardId_)) {
	    res+=' style="z-index: '+nCards+'; width: '+imgSize[sizeClass]*1.5;
	    if (nCards>1 && /[0123][\dJQKA]$/.exec(prevCard)) 
		res+='; margin-left: -1.5em;'; // let cards overlap to save space 
	    res+='"';
	    prevCard=cardId_;
	    }
	else res+=' width='+imgSize[sizeClass];
	}
    else {
	if (form0!="") { utf=form0+utf+form1; form0=''; form1=''; }
	res+='<span class="'+colorNames[color]+' '+sizeClass+'"';
	}
    tmp=_(help[cardId]) || cardId;
    if (tmp!=undefined && !noTitle) res+=' title="'+tmp+'"';
    if (setClick!="") {
	idNum++;
	tmp=setClick+idNum; info[tmp]=setClick+cardId;
	res+=' id="'+tmp+'" onClick="click_(this.id)"';
	}
    if (uImg>0) { res+='/>'; }
    else { res+='>'+utf+'</span>'; }
    }
  if (noUTF!='' && test) alrt("no utf for "+noUTF);
  if (test>10) 
    alrt("formatCards:"+res);
  if (test && res.indexOf("/>/>")>=0) alrt("formatCards("+cardIds+")="+res);
  return res;
  } // formatCards

function getUTFimg(cardId,color,utfImg_) { // returns utf code or image src
    var utf=cardUTF[cardId], tmp, res="";
    if (utfImg_==null) utfImg_=utfImg;
    if (utf==undefined) { 
	if (test>0) { 
	    alrt("*no utf for "+cardId);
	    //abort; // force abort
	    }
	utf=cardUTF["xx"]; cardId="xx"; color=null; 
	} 
    if (color==null) color=cardColor[cardId];
    if (test==7) alrt("*U("+cardId+")="+utf);
    if (/\.png/.exec(utf)) res="../PC/img/"+utf;
    else if (utfImg_>0) {
	//if (utfImg_>=2 && /[0123][\dJQKA]/.exec(cardId))
	if (utfImg_>=2 && /1F0[ABCD][\dABDE]/.exec(utf) 
	    && utf.substr(3,1)=="ABCD".substr(color,1)) {
	    tmp=cardsUtfEn[utf.substr(4)];
	    if (tmp==null) tmp="0"+utf.substr(4);
	    //if (tmp==null) tmp=utf.substr(4);
	    res=""+utfImg_+"/"+colorsEn[color]+"_"+tmp;
	    }
	else res='/I'+utf+'-'+color;
	res="../PC/img"+res+".png"; 
	}
    else {
	res='&#x'+utf+';';
	}
    return res;
    } // getUTFimg

function click_(idNum) {
    var tmp="--", id=info[idNum], id2=id.substr(2), id1=id.substr(0,1);
    var cat=category[id2];
    if (!cat) { alert("* no category for "+idNum); return; }
    if (test>3) alert("click "+idNum+" ->"+id+" cat="+cat);
    //else if (test>3) alrt("cat("+idNum+")="+cat); 
    if (cat.substr(0,1)=="p") {// turn playing card
	if (document.getElementById(idNum)) {
	    var tmp=getUTFimg("00");
	    if (utfImg>0) document.getElementById(idNum).src=tmp;
	    else setHTML(idNum,tmp);
	    }
	}
    else if (cat=="Local") localAct(id2,idNum);
    else if (cat=="Sort") {
	if (id2=="ss") {
	    if (sortSelected=="") alert(_("&choseSortMode()"))
	    else act("A",info[sortSelected].substr(2)); 
	    return;
	    }
	ownHand=sortCards(ownHand,id2);
	checkCards(ownHand);
	setPC("OWN","");
	if (sortSelected!="")
	    document.getElementById(sortSelected).style.backgroundColor='white';
	document.getElementById(idNum).style.backgroundColor=bgSel;
	sortSelected=idNum;
	}
    else act(cat.substr(0,1),id2+id1);
    if (test) 
	alrt("click_("+idNum+")="+info[idNum]+" utf="+tmp);
    } // click_

function localAct(id2,idNum) {
    if (test>3) alrt("localAct("+id2+","+idNum+")");
    id2=id2.substr(0,2);
    if (id2=="lt") {
	    var tmp="";
	    for (let k in info) { tmp+=k+"="+info[k]+"\n"; }
	    alert("Info:\n"+tmp);
	    }
    else if (id2=="li") { // display information
	    if (test>0) showProt()
	    else showHelp();
	    }
    else if (id2=="ji") { // jitsi
	    setJitsi();
	    }
    else if (id2=="uu") { // show next utf/image
	if (document.getElementById(idNum)) {
	    setImgMode();
	    var utfImg_=(utfImg<+info['maxImg']-1 ? utfImg+1 : 1);
	    var tmp=getUTFimg("uu",null,utfImg_);
	    //if (test>3) alrt("Image src for UTF-Umsch.="+tmp);
	    //if (utfImg>0) 
	    document.getElementById(idNum).src=tmp;
	    //else document.getElementById(idNum).innerHTML=tmp;
	    //alrt("Click("+idNum+")="+tmp+" utf="+cardUTF["uuannouncements"]);
	    }
	}
    else if (id2=="lc") { // display chat field
	    chat(1);
	    }
    else if (id2=="ls") {
	    clearTimeout(cancelTimeout);
	    }
    else if (id2=="an") {
	    info[':SUMM:GT']=(info[':SUMM:GT'] ? 0 : 1);
	    summaryTable();
	    }
    else if (id2=="gt") {
	    //  prompt for game points?;
	    }
    } // localAct

function checkCards(cardIds) {
    if (!cardIds) cardIds=ownHand;
    if (cardIds=="" || T>0) return "";
    var stdSort=sortCards(cardIds,info['SORT']); // card,... 
    var lenTrumps=stdSort.indexOf(", "); 
	// 1st blank separates trump/non-trump
    var nTrumps=0, nCards=0, pos, card, tmp; ownTrumps=""; 
    for (pos=0; pos<stdSort.length; pos++) {
	if (" ,".indexOf(stdSort.substr(pos,1))>=0) continue;
	card=stdSort.substr(pos,2);
	nCards++;
	pos++; // 2 characters per card
	if (pos<+lenTrumps) { 
	    nTrumps++; ownTrumps+=","+card; 
	    }
	}
    var buttons="";
    if (T==0 && nTrumps>0) {
	cardStat=formatCards("["+nTrumps+"*T]","small");
	}
    return buttons;
    } // checkCards

function sortCards(cardIds,sortId) { // only for solos (Sx)
    // CardIds must be separated by ','
    if (!sortId || !info['sorted-'+sortId]) 
	sortId=info['trumpsStd'] || "std";
    var sortIds=info['sorted-'+sortId];
    if (sortIds==undefined || sortIds=="") 
	{ alert(_("&choseSolo()")+" /"+sortId); return cardIds; }
    else { if (test>0) alrt("sort("+cardIds+";"+sortId+"):"+sortIds); }
    //var tmp=(sortId=="s2" ? "" : sortIds);
    //setPC("PARTNER",allCards); // tmp);
    var pos, pos2, res='', spec='';
    cardIds=","+cardIds; pos=0;
    while (pos<sortIds.length) {
	if (sortIds.substr(pos,1)==" ")
	    { res+=",  "; pos++; continue; }
	if (sortIds.substr(pos,1)==",") { pos++; continue; }
	var card=sortIds.substr(pos,2);
	pos2=cardIds.indexOf(","+card);
	if (pos2<0) { pos+=2; continue; }
	res+=","+sortIds.substr(pos,2);
	cardIds=cardIds.substr(0,pos2)+cardIds.substr(pos2+3);
	// no p+=2 : card might occur twice
	}
    cardIds=cardIds.replace(/\ /g,"").replace(/\,+/g,",");
    if (cardIds==",") cardIds="";
    res=cardIds+res; // ???
    if (test && cardIds!="") alrt("sorted:"+res+" sp="+cardIds);
    return res.substr(1);
    } // sortCards

function setPositions(posServer) {
    if (posServer==null) posServer=info['POS'];
    // posServer=current player numbers on server table
    // current player is placed at position 0 of client table
    // ownPos is set to position in current players (0..3)
    // ownNum ist set to player number (1..NP)
    var i, p, pS, msg='', np=info['NP'], lPos=posServer.length;
    //if (lPos<+np) return; // paused players ?
    if (ownNum<0) { // find player number
	for (pS=1; pS<=+np; pS++) { 
	    msg+=" "+pS+"="+info['N'+pS];
	    if (info['N'+pS]==player) { ownNum=pS; break; }
	    }
	if (ownNum<0) { alert(player+" not in player list"); return; }
	}
    ownPos=posServer.indexOf(""+ownNum);
    setHTML("ownNum","["+ownNum+"]","summ");
    // ownPos=-1 : not playing : show next player at position 0
    info['OWNPOS']=ownPos;
    pS=ownNum;
    highlight('N',posServer.substr(p,1),lPos);
    if (test>0) 
	alrt("setPos("+posServer+"): "+msg+" own: Num="+ownNum+" Pos="+ownPos);
    if (1 || info['R']>0) { setTrick(posServer,ownPos); } // always
    //if (N!=null && document.getElementById("T"+N))
	//document.getElementById("T"+lead).style.backgroundColor=bgPosition0;
    for (i=0; i<lPos; i++) {
	var j=posServer.substr(i,1);
	var name_p=info['N'+j] || "";
	var elem=document.getElementById("N-"+j);
	if (name_p && elem) elem.innerHTML=name_p;
	}
    } // setPositions

function setTrick(posServer,ownPos) {
    var trickPositions=new Array
	// positions of current player t in 3*3 table by number of players
      ('','7','71','702','7315','73025','730125','7301258','76301258');
    var lPos=posServer.length;
    var trickPos=trickPositions[lPos] || "";
    if (trickPos=="") 
	{ alert("setTrick("+posServer+") : no positions"); return ""; }
    if (ownPos) // ownPos should be at position 7 (middle of 3rd row)
	trickPos=trickPos.substr(-ownPos)+trickPos.substr(0,lPos-ownPos);
    if (test>0) alrt("setTrick("+posServer+") trickpos="+trickPos);
    var table="<table>"; 
    var tPos=0; // 0..8
    for (let i=0; i<3; i++) {
	table+="<tr>";
	for (let j=0; j<3; j++) {
	    table+="<td>";
	    var iTPos=trickPos.indexOf(""+tPos);
	    if (iTPos>=0) { // iTPos is position in current players (0..)
		var pNum=posServer.substr(iTPos,1);
		table+='<span id="T'+pNum+'_"></span>'+'<br>'
		      +'<span id="N-'+pNum+'" >'+info['N'+pNum]+'</span>';
		}
	    else if (tPos==4) {// middle of table
		var tmp=info['TM'] || "cc";
		table+='<span id="TM_">'+formatCards(tmp,"small")+'</span>';
		}
	    table+="</td>";
	    tPos++;
	    }
	table+="</tr>";
	}
    setHTML("TRICK",table);
    for (let p=0; p<lPos; p++) {
	var p_=posServer.substr(p,1);
	setHTML("T"+p_);
	var name=info['N'+p_];
	setHTML("N"+p_,name);
	}
    } // setTrick

function highlight(id_,n,max) { 
    // highlights <id_><n> and sets other <id_>* to white
    var p;
    for (p=0; p<=max; p++) { 
	var id=id_+p;
	if (document.getElementById(id)) {
	    document.getElementById(id).style.backgroundColor=
		(p==n ? bgPosition0 : 'white'); // bgPosition0
	    }
	}
    } // highlight

function showHelp() {
	if (helpWindow==null || helpWindow.closed)
	    helpWindow=open('PChelp-'+language+'.html', 'popup-PChelp', 
		'height=600, width=800, toolbar=no, status=no, menubar=no,'
		+'scrollbars=no, location=no, top=0, left=0, resizable=yes');
	else helpWindow.focus();
    
    } // showHelp

function chat(opt) { 
    // chat field also used for manual setConfig: %name=value -> info[name]=value
    //alrt("chat");
    if (opt==1) {
	var html='<input id="CHAT" type="text" size="50">';
	//onchange="document.getElementById('OUT').innerHTML=this.value">
	setHTML("ANNOUNCE",html);
	var input = document.getElementById("CHAT");
	input.focus();
	// Execute a function when the user releases a key on the keyboard
	input.addEventListener("keyup", function(event) {
	    // Number 13 is the "Enter" key on the keyboard
	    if (event.keyCode === 13) {
	    // Cancel the default action, if needed
		event.preventDefault();
		chat(); // trigger send option of chat
		}
	    });
	}
    else {
	var str=document.getElementById("CHAT").value;
	setPC("ANNOUNCE");
	if (str!="") {
	    if (str.substr(0,1)=="%" && setConfig(str)) {
		if (/\:SUMM/.str) summaryTable();
		}
	    else act("S","Sc"+str);
	    }
	}
    } // chat

function act(cat,cardId) {
    if (cardId!="wc") {
	if (test) alrt("act:"+cardId);
	if (cardId=="ok" && cardId==lastAct) cardId+="ok";
	else lastAct=cardId;
	}
    var cardId2=cardId.substr(0,2);
    var tmpC=cardUTF[cardId2]; 
    if (tmpC!=null) tmpC='&#x'+tmpC+';'; else tmpC=cardId2;
    var tmpM=cardUTF["r"+clientMode]; 
    if (tmpM!=null) tmpM='&#x'+tmpM+';'; else tmpM=clientMode;
    setHTML("CC",tmpC+tmpM);
    if (cardId2=="ss") { // manual settings
	var setting=prompt(help[cardId]+"\n (z.B. N:1;C:o4_2)","");
	if (setting==null || setting=="") return;
	cardId+=setting;
	}
    else if (cardId2=="hl" || cardId2=="pi") { // request for help / positions
	var names="", n, np=info['NP'];
	for (n=1; n<=+np; n++) {
	    if (cardId2=="pi" || (ownNum!=n && info['N'+n]!=""))
		names+=","+n+"="+info['N'+n]; 
		}
	names=names.substr(1);
	var setting=prompt(help[cardId2]+"\n "+names+" (z.B. 2,3,1)","");
	if (setting==null) return;
	cardId=cardId2+setting;
	}
    else if (cardId2=="bk") { // delay 1 step back : double click -> 2 steps, ...
	stepBack++;
	setPC("HINT",cardId+"["+stepBack+"]");
	cancelTimeout=setTimeout('act("S","BK")',300);
	return;
	}
    else if (cardId2=="BK") { // 'BK' from setTimeout : send BK + stepBack count
	setPC("HINT","bk["+stepBack+"+1]"); // 'BK' is not a symbol
	cardId+=stepBack;
	stepBack=0;
	}
    else if (cardId2=="pt") { // manual input of points
	var gp=info['GP']; 
	gp=(gp.substr(0,1)=="#"? gp.substr(1) : ''); // server suggestion or ''
	var tmpAsk=info['help-'+cardId2] || "";
	if (tmpAsk!="") tmpAsk+="\n&alternatively(): ";
	tmpAsk+="&playernumber()=&points(),... (&eg(). 1:3,3=-1)"
		+" / &countedFrom() 1="+info["N1"];
	var points=prompt(_(help[cardId2]+"\n"+tmpAsk),gp);
	if (points==null|| points=="") return;
	// var pp=/^([RK]?)[^\-\+\d]*([\+\-]?\d+)$/.exec(points);
	cardId+=points; // pp[0]+"/"+pp[1];
	if (test>2) 
	    alrt(cardId);
	}
    cardId=cardId.replace(/\=/g,":");
    var query="P="+info[':ID']+"&C="+cat+"&I="+cardId;
    if (cardId!="rl") 
	query+="&FS="+info['FS']; // ?? (0+..) blanks in TS ?
    //else 
    if (cardId=="jn") {
	if (params['M']!=undefined) query+="&M="+params['M'];
	query+="&LANG="+language;
	}
    if (test>1) 
	query+="&test="+test;
    if (clientMode!="") query+="&mode="+clientMode;
    if (test) query+="&n="+player;
    if (test>2 || reqCnt>1) 
	    setPC("HINT","[q="+query+" reqCnt="+reqCnt+" (open request)]");
    query=sndReq(PCserver,query);
    if (jitsiStatus==1 && jitsiWindow!=null && !jitsiWindow.closed
		&& cardId!="wc")
	jitsiWindow.focus();
    if (test>0)
	if (cardId!="wc") 
	    setPC("HINT","[query:"+query+" sendstatus:"+http.statusText+"]");
    } // act

function joinTable() {
    // if (info['MSG']!="") { info['MSG']=""; return; }
    if (info['myP']=='') { // not yet replaced by given player number
	setPC("HINT","wc["+table+"]"); 
	cnt=0;
	act("N","jn"); // New /server will only respond when table is complete
	}
    else act("S","rl"); // reload
    } // joinTable

function createRequestObject() {
    var reqObj;
    var browser = navigator.appName;
    if(browser == "Microsoft Internet Explorer")
	{ reqObj = new ActiveXObject("Microsoft.XMLHTTP"); }
    else { reqObj = new XMLHttpRequest(); }
    return reqObj;
    } // createRequestObject

function sndReq(file,query) {
    if (test==2) return "not sent (test=2)";
    if (usePrompt>0) {
	query+="&sep=|";
	checkResponse(prompt("Result of "+file+" '"+query+"'",""));
	return;
	}
     if(http && reqCnt>0) {
	try {
	    http.onreadystatechange = null;
	    http.abort();
	} catch (e) { setPC("HINT","[http-Fehler: "+e+"]"); }
	reqCnt--;
     }

    query=encodeURI(query); // convert special characters to %xx notation
    if (cancelTimeout) clearTimeout(cancelTimeout);
    http.open('get', file+'?'+query, true);
    http.onreadystatechange = handleResponse;
    http.send(null);
    reqCnt++;
    if (test>2) 
	alrt(query+" rCnt="+reqCnt+" sendReq: "
	    +"readyState="+http.readyState+"="+http.statusText);
    return query;
    } // sndReq

function handleResponse() {

    if(http.readyState == 4) {

       var response = http.responseText;
       var result = new Array();
       var i, nameVal, name, val, tmp;

       var responseCode=http.responseCode;
       if (response==undefined || responseCode!=200 || test>0) 
	    alrt("response: l="+response.length+" code="+responseCode
		+" status: "+http.readyState+"="+http.statusText);
	reqCnt--;
	checkResponse(response,http.statusText);
        }
    else { 
	if (test>0) alrt("response: state="+http.readyState
		    +" status="+http.status+" ="+http.statusText);
	// 0=unsent, 1=opened, 2=headers received, 3=loading, 4=done
	//???if (http.readyState==2) //2: headers received
	//if (http.statusText!=null && http.statusText!="")
	    //setPC("HINT",
		//"[http-Status="+http.statusText+"/"+http.readyState+"]");
	}

    } // handleResponse

function checkResponse(response,statusText) {
    if (response=="") { 
	setPC("HINT","[&noResponse(),]rl[?]"); // at least 1 line expected
	cancelTimeout=setTimeout('act("S","wc10s")',2000); // await change
	return; 
	} 
    //alrt("response: "+response);
    setHTML("CC",'&#x270D;'); // show 'writing hand'
    var i, P, N, F, P_, tmp, chg=new Array(), err=0;
    var setOwn=0, msg=""; var minWait_=minWait;
    if (test>0) setOwn=1;
    if (statusText.indexOf("Server Error")>=0) minWait_=-1;
    var result = response.split(sep);
    var lRes=result.length; //alrt("lRes="+lRes+" response:\n"+response);
    // ??? setPC("HINT",""); // reset last personal hint
    var newVal=new Array(); var nConf=0;
    //info["HINT"]="[...]";
    for (i=0; i<+lRes; i++) {
	    if (result[i]=="" || result[i].substr(0,1)=="*") continue;
	    var nameVal=result[i].split("=");
	    var name=nameVal[0]; var val=nameVal[1];
	    if (name=="ERR") { 
		info["HINT"]=(err==0 ? val : info["HINT"]+"<br>"+val);
		err++;
		minWait_=(/(unknow|verifiz)/.exec(val) ? 20000 : 2000);
		continue; 
		} // setPC("HINT",val);
	    if (name.substr(0,1)=="%") { setConfig(result[i]); nConf++; }
	    else {
		if (test>2) alrt("*"+nameVal+"("+info[name]+")ln="+name.length);
		if (name.substr(0,1)==":") evaluateOptions(name,val);
		info[name]=val;
		newVal[name]=1;
		}
	}
    if (nConf>0) {
	if (test) alrt("** config received="+nConf);
	setLogos();
	}
    //if (test>0 && alrtArr.length>0) showProt();
    F=info['F'] || 0; T=info['T'] || 0; CPP=info['CPP'] || 1; 
    PC=info['PC'] || 0; POS=info['POS'] || "";
    if (info['myName']) player=info['myName'];
    if (newVal["GAME"]!=null || newVal["game"]!=null) {
	initTable();
	}
    if (newVal["NP"]!=null || newVal["POS"]!=null || newVal["PAUSED"]!=null) {
	summaryTable();
	if (newVal["POS"]!=null) {
		setPositions();
		setOwn=1;
		}
	}
    for (let name in newVal) {
	val=info[name];
	    if(divStyle[name]!=undefined) {
		if (test && name=="PARTNER") alrt("Div: "+name+"="+val);
		setPC(name,val); 
		}
	    else if (name=='CP' || name=='N') {
		// CP=current players, N=player of next card, X=.. start trick
		if (test) alrt("CP/N:");
		for (let p=0; p<POS.length; p++) {
		    var P=POS.substr(p,1);
		    var elem=document.getElementById('N-'+P);
		    if (elem) {
			var bgCol=(val.indexOf(""+P)>=0
				    ? bgCP : 'white');
			elem.style.backgroundColor=bgCol;
			}
		    else if (test)
			alrt(" CP-bg POS="+POS+" cp="+val+" not found: "+'N'+P);
		    }
		}
	    else if (name=='X') highlight("N",val,info['NP']);
	    else if (name.length<=2) { // Ti,Ai
		var szVal=(/T\d/.exec(name) ? "trick" 
		    : (name=="TM" || name=="LT" ? "small" : "summ"));
		setHTML(name,val,szVal);
		}
	    else if (name.indexOf(".")>0) {
		// I. H. B.
		setOwn=1; 
		var name2=name.substr(0,2);
		if (name2=="H.") {
		    if (val.length<2) val="00"; // placeholder for empty hand
		    if (test>0 && info[name]!=ownHand)
			alrt("..hand: "+name+"="+val+" o="+ownHand)
		    }
		else if (name2=="P.") {
		    if (val!="") {
			var P=name.substr(2);
			val=sortCards(val,info['SORT']);
			tmp=info['N'+P] || "";
			val="["+tmp+"]"+val;
			}
		    if (P!=null && P>0) setPC("PARTNER",val);
		    }
		else if (name2=="M.") { 
		    info["HINT"]=val;
		    setPC("HINT",val);
		    }
		else if (name2=="B." && val.indexOf("nt")>=0) { 
		    // trigger finishTrick
		    cancelTimeout=setTimeout('act("S","nt")',1000); 
		    val=""; // nt only once
		    }
		}
	    else if (name=="OWNHAND" || name=="T" || name=="SORT" || name=="N") {
		setOwn=1;
		if (sortSelected!="" && document.getElementById(sortSelected)) {
		    document.getElementById(sortSelected).style.backgroundColor
			='white';
		    sortSelected="";
		    }
		}
	    else if (document.getElementById(name) && divStyle[name]) {
		if (name.indexOf("_")<0) val=formatCards(val,"small");
		if (test && val.indexOf("1F0B0")>=0) alrt("xx "+name+"="+val);
		document.getElementById(name).innerHTML=val;
		}
	}
    if (setOwn>0 && info["H."+ownNum]!=null) {
		var ownH=info["H."+ownNum];
		if (test>0 && ownHand.length>3) 
		    alrt("OH("+ownNum+"): H.="+ownH+" o="+ownHand)
		//setPC("HINT","[...]");
		ownHand=sortCards(ownH,info['SORT']);
		//ownButtons=info["B."+ownNum] || ""; // 
		checkCards(ownHand);
		//alrt("oh="+ownHand+" b="+ownButtons+"/"+ownNum+":"+info["B."+ownNum]);
		setPC("OWN","");
		}
	else if (setOwn>0 && test) alrt("* ownNum? ="+ownNum);
	if (PC==0 && POS=="" && err==0) {
	    setPC("HINT","[&waitForPlayers() ("+cnt+")]");
	    cnt+=10;
	    cancelTimeout=setTimeout('act("S","wc10s")',10000); // wait for change
		// w/o the "'", act will be executed before passed to
		// setTimeout
	    return;
	    }
	if (learner==0 && allCards!="" && PC>0) //  && T==0 && test>=0
	    { allCards=""; setPC("PARTNER"); }
	//setPC("SUMMARY","[Runde "+info['R']+" "+info['N'+F]+']'+info['LT']);
	tmp=(T==0 ? info['T0B'] : info['TxB']);
	if (tmp==null) tmp="";
        setPC("ANNOUNCE",tmp); 
	setPC("HINT");
	
	if (T<=+CPP) { //CPP) {
	    N=info['N'] || ""; var CP=info['CP'] || "";
		if (test>0)
		    //if (T==CPP) 
		    alrt("T="+T+" N="+N+" ownP="+ownPos+" CP="+CP+" CPP="+CPP);
	    if (N!="" && CP!="X") {
		if (test>0) alrt("setPC(T"+N+")");
		if (info['AUTO'].indexOf('LAST')>=0 && T==CPP && N==ownNum) {
		    //setPC("HINT","[T="+T+" N="+N+" h="+ownHand+"]");
		    ownHand=ownHand.replace(/[^\w\d]/g,"");
		    if (ownHand.length>3) 
			alert(_("&lastTrick() ? &trick()="+T+" : "+ownHand))
		    cancelTimeout=setTimeout('act("P",ownHand)',1000); 
		    // delay to avoid race for checkResponse
		    setPC("ANNOUNCE",
			info['LT']+"/[&lastTrickAutomatic()]");
		    return; // 
		    }
		}
	    else if (CP.indexOf(""+ownNum)>=0) setPC('T'+ownNum,"qq");
	    }
	//if (N!=ownNum && info['STOP']==0) 
	if (minWait_>0)
	    cancelTimeout=setTimeout('act("S","wc'+minWait_+'")',minWait_); // await change
    } // checkResponse

function setConfig(line) {
    var res=0;
    var lineParts=/^\%(\w+)(\_)([\w\d]+)\=(.*)$/.exec(line);
    if (lineParts!=null) { // card format: %CATEGORY_CC TAB UTF;HELPTEXT;COLOR
	if (test==8) alrt("Config: 1="+lineParts[1]+" 3="+lineParts[3]);
	if (lineParts[1]!="Msg") {
	    var valArr=lineParts[4].split(";");
	    var color=valArr[2]; 
	    if (color==null || color=="") color=0;
	    else if (color.indexOf("#")>=0) 
		color=color.substr(0,color.indexOf("#"))
	    setHelpUTF(lineParts[3],valArr[0],valArr[1],color);
	    category[lineParts[3]]=lineParts[1];
	    //alrt("->u="+valArr[0]+" h="+valArr[1]);
	    res=1;
	    }
	else {
	    var str=lineParts[4].replace(/\\n/g,"\n");
	    if (help[lineParts[3]]!=null) {
		if (test==8) alrt("+help "+help[lineParts[3]]+" : "+str);
		help[lineParts[3]]=str;
		}
	    Msg[lineParts[3]]=str;
	    }
	}
    else {
	lineParts=/^\%([^\=]+)\=(.*)$/.exec(line);
	if (lineParts!=null) {
	    info[lineParts[1]]=lineParts[2];
	    res=2;
	    if (test==8) alrt("Config: 1="+lineParts[1]+" 2="+lineParts[2]);
	    }
	else if (test>0) 
	    alrt("*unkown config: "+line);
	}
    return res;
    } // setConfig

function setHTML(id,val,sz) {
    if (val==null) val=info[id] || "";
    if (sz==null) sz="small";
    var elem=document.getElementById(id);
    if (elem==null) {
	elem=document.getElementById(id+"_");
	if (!elem || id.length!=2) { // try "_" only for Ai,Ti,...
	    if (test>3) alrt("**setHTML("+id+","+val+"): no element");
	    return;
	    }
	id+="_";
	}
    if (test>3) alrt("**SetHTML("+id+","+val.substr(0,10)+")");
    if (id.substr(-1)=="_") val=formatCards(val,sz);
    document.getElementById(id).innerHTML=val;
    } // setHTML

function readParams(queryStr) {
    if (!queryStr) queryStr = self.location.search;
    var params = {}, queries, temp, i, l;
    queryStr=decodeURI(queryStr); // convert special characters %xx to characters

    if (queryStr.substr(0,1)=="?") queryStr=queryStr.substr(1);
    // Split into key/value pairs
    queries = queryStr.split("&");

    // Convert the array of strings into an object
    for ( i = 0, l = queries.length; i < +l; i++ ) {
        temp = queries[i].split('=');
        if (temp[1]==null) temp[1]=1; // w/o =VALUE -> 1
        params[temp[0]] = temp[1];
	}

    return params;
    } // readParams

function evaluateOptions(optName,options) { 
    // options=EXP,... EXP=NAME | NAME=VAL,...
    // sets info[optName+':'+NAME]=1 or info[optName+':'+NAME:i]=VAL (i=0...)
    var optParts=options.split(",");
    for (let i=0; i<optParts.length; i++) {
	var opt0=optParts[i], val=1;
	var optParts1=opt0.split(":");
	if (optParts1.length>1) {
	    for (let j=1; j<optParts1.length; j++) {
		opt0=optName+":"+optParts1[0]+":"+j;
		val=optParts1[j];
		info[opt0]=val;
		if (test) alrt("**opt: "+opt0+"="+val);
		}
	    }
	else {
	    opt0=optName+":"+opt0;
	    info[opt0]=val;
	    if (test) alrt("**opt: "+opt0+"="+val);
	    }
	}
    } // evaluateOptions

function summaryTable(np) {
    if (!np) { np=info["NP"]; if (!np) return; }
    var i,j; var pos=info['POS']; var N=info['N'];
    var lead=pos.substr(0,1);
    
    var strN_="<th id='POS0'></th>";
    if (info[":SUMM:POS0:1"]) 
	var tmpN=info[":SUMM:POS0:2"]; var tmpV=info[tmpN] || "";
	strN_="<th id='"+info[":SUMM:POS0:1"]
	    +"' title='"+_(tmpN)+"'>"+tmpV+"</th>";
    var strG_="<td>"+formatCards("gt","summ","S_")+"</td>"; // grand total
    var strW_="<td>"+formatCards("tw","summ")+"</td>"; // tricks won
    var strA_="<td>"+formatCards("an","summ","Lg")+"</td>"; // announcements
    var tmp, tmp2; var paused=info['PAUSED'] || "";
    for (let p=1; p<=+np; p++) {
	tmp=info['N'+p] || ""; 
	if (tmp==player) ownNum=p;
	if (paused.indexOf(""+p)>=0) tmp='<i>'+tmp+'</i>';
	strN_+="<th id='N"+p+"'>"+tmp+"</th>";
	tmp=info['G'+p] || ""; strG_+="<td id='G"+p+"'>"+tmp+"</td>";
	tmp=info['W'+p] || ""; strW_+="<th id='W"+p+"'>"+tmp+"</th>";
	tmp=info['A'+p] || ""; //tmp2=info['P'+p] || ""; 
	//if (tmp2!="") tmp+="/"+tmp2;
	if (tmp!="") tmp=formatCards(tmp,"summ");
	    strA_+="<td id='A"+p+"_'>"+tmp+"</td>";
	}
    var str="<table><thead><tr>"+strN_+"</thead></tr>";//  border='1'
    if (info[":SUMM:GT"]) str+="<tr>"+strG_+"</tr>";
    str+="<tr>"+strW_+"</tr>"+"<tr>"+strA_+"</tr>";
    str+="</table>";
    str+="<span id='LT_' title='"+_("&lastTrick()")+"'>...</span>"; 
	// last trick
    if (test) alrt("summary: "+np);
    setHTML("SUMMARY",str);
    if (lead && document.getElementById('N'+lead))
	document.getElementById('N'+lead).style.backgroundColor=bgPosition0;
    if (ownNum==1 || allowSettings) { // ==info['N'] ?
	str=",ok";  // ok to start
	str+=",bk"; // possibility to go back
	if (info['AUTO'].indexOf('POIN')>=0) str+=",pt";
	if (allowSettings) str+=",lg,lt"; // (local) gear, test
	setHTML("SPECIAL",formatCards(str,"special","A0"));
	}
    } // summaryTable

function alrt(str) { 
    alrtArr.push(str); 
    if (alrtArr.length>100) showProt();
    }

function showProt() {
    if (test==0 || confirm(alrtArr.join("\n")+"\nDelete ?"))
	alrtArr=[];
    }
function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
	c = c.substring(1);
	}
    if (c.indexOf(name) == 0)
      return c.substring(name.length, c.length);
    }
  return "";
  } // getCookie

function splitURL(url) { // returns array [domain,dir,name,type]
    var urlParts=url.split(/\//);
    var prog=urlParts.pop();
    var prot="";
    if (/http/.exec(urlParts[0])) prot=urlParts.shift();
    while (urlParts[0]=="") urlParts.shift();
    var domain=urlParts.shift();
    var name=prog; var type="";
    var tmp=/^(.*)\/([^\/]+)(\.htm.*)$/.exec(url);
    if (tmp!=null) name=tmp[2]; type=tmp[3];
    var dir=urlParts.join("/");
    return [prot,domain,dir,name,type];
    } // splitURL

</script>
</body>
